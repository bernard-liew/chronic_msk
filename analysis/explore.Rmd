---
title: "explore"
author: "Bernard"
date: "2022-10-06"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Load package

```{r}
library(tidyverse)
library(data.table)
library (cowplot)
library (officer)
library (flextable)
library (dataPreparation)

# ML
library (mgcv)
library (mgcViz)
library (buildmer)
library (DHARMa)
library (gratia)
```

## Import data

```{r}
df <- rio::import ("data/BBDD.xlsx")
df <- janitor::clean_names(df)
```

# Explore

```{r}
skimr::skim (df)

mice::md.pattern(df, rotate.names = TRUE)
```


# Subset

```{r}
df2 <- df %>%
  dplyr::select(gender, 
         age, 
         main_pain_location, 
         pain_extent,
         profession_status, 
         educational_level, 
         comorbidity,
         gcps_total_baseline,
         expect_final_score,
         lot_r_final_score,
         cpaq_final_score,
         gcps_total_1year_follow_up) 

names(df2) <- c("gender",
                "age",
                "pain_loc",
                "pain_ext",
                "work",
                "education",
                "comorbidity",
                "gcps",
                "expect",
                "lot",
                "cpaq",
                "gcps_t1")

df2 <- df2%>%
  mutate (pain_loc = case_when(
    
    pain_loc %in% c(2, 7, 8, 9) ~ "UL",
    pain_loc %in% c(3, 4, 5) ~ "LL",
    pain_loc == 0 ~ "Lx",
    pain_loc == 1 ~ "Cx",
    TRUE ~ "FM"
  )) %>%
  mutate_at (c("gender", "pain_loc", "pain_ext", 
               "work", "education", "comorbidity"), factor)
skimr::skim (df2)
```

# Impute

```{r}
# imp <- mice::mice(df2, m = 20, seed = 155, maxit = 30, meth = "rf")
# 
# saveRDS(imp, "output/imp.RDS")
imp <- readRDS("output/imp.RDS")

set.seed(123)
rand_n <- sample (1:20, 1)

df3 <- mice::complete (imp, rand_n)

pred_num <- c("age", "gcps", "expect", "lot", "cpaq")

skimr::skim (df3)

df4 <- df3 %>%
  mutate_at(vars (age, gcps, expect, lot, cpaq), scale, center = TRUE, scale = FALSE)

```

```{r}
ggplot (df3) +
  geom_point(aes (x = cpaq, y = gcps_t1))
```

# GAM

## Formula

```{r}
fgam <- gcps_t1 ~ 
  gender +
  pain_loc  + 
  pain_ext  + 
  work  + 
  comorbidity  + 
  s(age)  + 
  s(gcps)  + 
  s(expect)  + 
  s(lot)  + 
  s(cpaq) 

```


### Gaussian distribution

```{r}

gam1 <- gam(fgam, data = df4)
summary(gam1) # deviance explained = 42.4%
anova(gam1)

appraise(gam1)

simulationOutput <- simulateResiduals(fittedModel = gam1)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

### ZiP distribution

```{r}
gam2 <- gam(fgam, data = df4, family = ziP)
summary(gam2) # deviance explained = 94.6%
anova(gam2)

appraise(gam2)

b <- getViz(gam2)
print(plot(b, allTerms = T), pages = 1) 

p <- tidygam::predict_gam(gam2, 
                          series = "gcps",
                          exclude_terms = list("gender",
                                                   "pain_loc",
                                                   "pain_ext",
                                                   "work",
                                                   "comorbidity", 
                                                   "s(age)",
                                                   "s(expect)",
                                                   "s(lot)",
                                                   "s(cpaq)"))

simulationOutput <- simulateResiduals(fittedModel = gam2)
plot(simulationOutput)
testZeroInflation(simulationOutput)

plot(gam2)
gam.check(gam2)
# convergence check
gam2$outer.info
# examine if the range of predicted values 
# is sane for the zero cases
range(predict(gam2, type = "response")[df4$gcps_t1==0])
# check zero prediction 
boxplot(predict(gam2) ~ (df4$gcps_t1==0))

f = plot_smooths(model = gam2, series = gcps)
```

## Stepwise

```{r}
gam3 <- buildgam(fgam, data = df4, family = ziP)
b <- getViz(gam3@model)
print(plot(b, allTerms = T), pages = 1) 

draw(gam3@model, select = c("s(cpaq)", "s(expect)", "s(age)"))
```

